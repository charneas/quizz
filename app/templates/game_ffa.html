<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Mode FFA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        h1 {
            text-align: center;
            color: #1a73e8;
        }
        .game-setup {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .player-list {
            list-style: none;
            padding: 0;
        }
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 5px;
        }
        .game-controls {
            text-align: center;
            margin-top: 20px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #1557b0;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .question-panel {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .answer-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>Mode Free-For-All</h1>
    
    <div class="game-setup">
        <h2>Entrée de la partie</h2>
        <input type="text" id="gameCode" placeholder="Code de la partie">
        <button onclick="joinGame()">Rejoindre</button>
        
        <h2 style="margin-top: 30px;">Joueurs</h2>
        <input type="text" id="playerName" placeholder="Nom du joueur" disabled>
        <button id="addPlayerBtn" onclick="addPlayer()" disabled>Ajouter un joueur</button>
        <ul class="player-list" id="playersList">
            <!-- Liste des joueurs -->
        </ul>

        <div class="game-controls">
            <!-- Le bouton "Commencer la partie" est géré par l'admin -->
        </div>
    </div>

    <div id="questionPanel" class="question-panel">
        <h2>Question pour <span id="currentPlayer"></span></h2>
        <p id="questionText"></p>
        <input type="text" class="answer-input" id="answer" placeholder="Votre réponse">
        <button onclick="submitAnswer()">Valider</button>
        <div id="answerDisplay" style="display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50;">
            <h4>Réponse:</h4>
            <p id="answerText" style="font-size: 18px; font-weight: bold; color: #2e7d32;"></p>
        </div>
    </div>

    <script>
        let players = [];
        let gameId = null;
        let gameCode = null;
        let gameStarted = false;
        const API_BASE_URL = "http://51.159.55.57:8001";
        let gameStatusInterval = null;
        let questionPollingInterval = null;
        let lastQuestionId = null;

        // Helper function to get auth header
        function getAuthHeader() {
            const credentials = 'admin:admin123';
            return 'Basic ' + btoa(credentials);
        }

        // Helper function for authenticated fetch
        function fetchWithAuth(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['Authorization'] = getAuthHeader();
            return fetch(url, options);
        }

        // Check game status every 2 seconds
        function startGameStatusPolling() {
            if (gameStatusInterval) {
                clearInterval(gameStatusInterval);
            }
            
            gameStatusInterval = setInterval(() => {
                if (!gameId) return;
                
                fetch(`${API_BASE_URL}/games/${gameId}`)
                    .then(response => response.json())
                    .then(game => {
                        if (game.state === 'running' && !gameStarted) {
                            gameStarted = true;
                            document.getElementById('questionPanel').style.display = 'block';
                            startQuestionPolling();
                        }
                        
                        // Check if admin sent a new question
                        if (game.state === 'running' && game.current_question_id && game.current_question_id !== lastQuestionId) {
                            lastQuestionId = game.current_question_id;
                            // Hide answer when new question appears
                            document.getElementById('answerDisplay').style.display = 'none';
                            document.getElementById('answer').value = '';
                            // Fetch the current question (not random)
                            fetchWithAuth(`${API_BASE_URL}/games/${gameId}/question/current`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data && data.text) {
                                        displayQuestion(data.text, players[0] ? players[0].name : 'Joueur');
                                    }
                                })
                                .catch(error => console.error('Erreur lors de la récupération de la question:', error));
                        }
                        
                        // Check if answer should be shown
                        if (game.current_answer) {
                            document.getElementById('answerDisplay').style.display = 'block';
                            document.getElementById('answerText').textContent = game.current_answer;
                        }
                    })
                    .catch(error => console.error('Erreur lors du polling:', error));
            }, 2000);
        }
        
        // Poll for new questions when admin sends them
        function startQuestionPolling() {
            if (questionPollingInterval) {
                clearInterval(questionPollingInterval);
            }
            
            questionPollingInterval = setInterval(() => {
                if (!gameId || !gameStarted) return;
                
                fetch(`${API_BASE_URL}/games/${gameId}`)
                    .then(response => response.json())
                    .then(game => {
                        // Check if admin sent a new question
                        if (game.current_question_id && game.current_question_id !== lastQuestionId) {
                            lastQuestionId = game.current_question_id;
                            // Hide answer when new question appears
                            document.getElementById('answerDisplay').style.display = 'none';
                            document.getElementById('answer').value = '';
                            // Fetch the current question (not random)
                            fetchWithAuth(`${API_BASE_URL}/games/${gameId}/question/current`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data && data.text) {
                                        displayQuestion(data.text, players[0] ? players[0].name : 'Joueur');
                                    }
                                })
                                .catch(error => console.error('Erreur:', error));
                        }
                        
                        // Check if answer should be shown
                        if (game.current_answer) {
                            document.getElementById('answerDisplay').style.display = 'block';
                            document.getElementById('answerText').textContent = game.current_answer;
                        }
                    })
                    .catch(error => console.error('Erreur lors du polling:', error));
            }, 1000);
        }

        function joinGame() {
            gameCode = document.getElementById('gameCode').value.trim().toUpperCase();
            if (!gameCode) {
                alert('Veuillez entrer un code de partie');
                return;
            }

            // Join the game
            fetch(`${API_BASE_URL}/games/${gameCode}/join`, {
                method: 'GET',
                headers: {
                    'accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Partie non trouvée');
                return response.json();
            })
            .then(data => {
                gameId = data.id;
                console.log('Partie rejointe:', data);
                
                // Enable player inputs
                document.getElementById('playerName').disabled = false;
                document.getElementById('addPlayerBtn').disabled = false;
                document.getElementById('gameCode').disabled = true;
                document.getElementById('gameCode').value = gameCode;
                
                // Start polling for game status
                startGameStatusPolling();
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur: ' + error.message);
            });
        }

        function addPlayer() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Veuillez entrer un nom de joueur');
                return;
            }

            if (!gameId) {
                alert('Veuillez rejoindre une partie d\'abord');
                return;
            }

            // Add player via API
            fetchWithAuth(`${API_BASE_URL}/games/${gameId}/players`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: playerName})
            })
            .then(response => response.json())
            .then(data => {
                console.log('Joueur ajouté:', data);
                players.push({id: data.id, name: data.name, score: data.score});
                updatePlayersList();
                document.getElementById('playerName').value = '';
                
                // Disable input and button after adding a player
                document.getElementById('playerName').disabled = true;
                document.getElementById('addPlayerBtn').disabled = true;
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout du joueur');
            });
        }

        function updatePlayersList() {
            const list = document.getElementById('playersList');
            list.innerHTML = players.map(player => 
                `<li class="player-item">${player.name} - Score: ${player.score}</li>`
            ).join('');
        }

        function nextQuestion() {
            if (!gameId) {
                alert('Veuillez rejoindre une partie d\'abord');
                return;
            }

            // Get a random question from the game
            fetchWithAuth(`${API_BASE_URL}/games/${gameId}/question/random`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.text) {
                        lastQuestionId = data.id;
                        displayQuestion(data.text, players[0] ? players[0].name : 'Joueur');
                    } else {
                        alert('Aucune question disponible');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la récupération de la question');
                });
        }

        function displayQuestion(question, playerName) {
            document.getElementById('questionPanel').style.display = 'block';
            document.getElementById('currentPlayer').textContent = playerName;
            document.getElementById('questionText').textContent = question;
            document.getElementById('answer').value = '';
            document.getElementById('answerDisplay').style.display = 'none';
        }

        function submitAnswer() {
            const answer = document.getElementById('answer').value.trim();
            if (!answer) {
                alert('Veuillez entrer une réponse');
                return;
            }
            
            // For now, just show a message
            alert('Réponse envoyée: ' + answer);
            document.getElementById('answer').value = '';
        }
    </script>
</body>
</html>
